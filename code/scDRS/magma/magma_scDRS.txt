# Step 1: download MAGMA software, gene location file, and reference data from
# https://ctg.cncr.nl/software/magma after this step, one should have a folder <MAGMA_DIR>
# with the following files:
# 1) <MAGMA_DIR>/magma 2) <MAGMA_DIR>/g1000_eur.(bed|bim|fam) 3) <MAGMA_DIR>/NCBI37.3.gene.loc

magma_dir=<MAGMA_DIR>

    # Step 2: make gene annotation file for MAGMA using the following command, this only needs to be done
    # once for different GWAS summary statistics, and the file will be saved to out/step1.genes.annot
    mkdir -p out/step1
magma
--annotate window=35,10
--snp-loc mdd.pval
--gene-loc grch38_lift.gene.loc
--out out/step1_mdd_all

# Step 3: run MAGMA using the following command, this takes a GWAS file ${trait}.pval,
# which at least has the columns: SNP, P, N, which corresponds to the SNP id
# (matched to the ${magma_dir}/g1000_eur.bim), p-value, sample size. For example,
# <trait>.pval file looks like
#
# CHR     BP      SNP             P           N
# 1       717587  rs144155419     0.453345    279949
# 1       740284  rs61770167      0.921906    282079
# 1       769223  rs60320384      0.059349    281744
#
# After this step, one should obtain a file out/step2/${trait}.gene.out, and the top genes with
# largest Z-scores can be input to scDRS.
magma --bfile $BFILE
--gene-annot SNP_Data/PTSD_Nievergelt2019_10xPilotGenes.genes.annot
--pval ../MAGMA/GWAS_Results/MVP.TE.REX.txt use=SNP,P ncol=N
--gene-model ${model}
--out SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_${model}


mkdir -p out/step2
magma
--bfile g1000_eur
--gene-annot out/step1_AD.genes.annot
--pval ad.pval use=SNP,P ncol=N
--out out/step2/ad_pt2

magma --bfile g1000_eur --pval ad_lift.pval ncol=N --gene-annot out/step1_ad.genes.annot.txt --out out/step2/ad_pt2 --big-data on
magma --bfile g1000_eur --pval mdd.pval ncol=N --gene-annot out/step1_mdd_all.genes.annot --out out/step2/mdd_pt2
magma --bfile g1000_eur --pval scz.pval ncol=N --gene-annot out/step1_scz.genes.annot --out out/step2/scz_pt2


magma --bfile g1000_eur --pval ad_lift.pval ncol=N --gene-annot out/step1_ad.genes.annot.txt --batch 2 chr --out out/step2/ad_pt2
magma --merge out/step2/ad_pt2 --out out/step2/ad_pt2


scdrs munge-gs \
--out-file out/step3/ad_rnaseq_early.gs \
--pval-file out/step2/scz_rnaseq.tsv \
--weight zscore


scdrs compute-score \
--h5ad-file sce.h5ad \
--h5ad-species human \
--gs-file out/step2/ketamine.tsv \
--gs-species human \
--out-folder out/step3 \
--flag-filter-data False \
--flag-raw-count False \
--n-ctrl 1000 \
--cov-file cov.tsv \
--flag-return-ctrl-raw-score False \
--flag-return-ctrl-norm-score True

cov<-model.matrix(~sex+age+round+brnum+detected+sort,colData(sce))

sce2<-readH5AD(
    file='sce.h5ad',
    X_name = 'logcounts',
    use_hdf5 = FALSE,
    reader = c("R"),
    version = NULL,
    verbose = T
)

wmodel="snp-wise"
ANNO=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA/GRCh38-ensembl93_to_hg19-lifted_30k-expressing-GENES.gene.loc
MAGMA=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA_v1_08/magma
BFILE=/dcl02/lieber/ajaffe/SpatialTranscriptomics/HumanPilot/Analysis/Layer_Guesses/MAGMA/g1000_eur
PREVPATH=/dcl02/lieber/ajaffe/Nick_Clifton/magma
setcol=1
genecol=2

gs_dlpfc=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA/dlpfcMarkerSets_fdr1e-6.txt
gs_sacc=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA/saccMarkerSets_fdr1e-6.txt
gs_hpc=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA/hpcMarkerSets_fdr1e-6.txt
gs_nac=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA/nacMarkerSets_fdr1e-6.txt
gs_amy=/dcs04/lieber/marmaypag/Tran_LIBD001/Matt/MNT_thesis/snRNAseq/10x_pilot_FINAL/MAGMA/amyMarkerSets_fdr1e-6.txt


## Step 1 - Annotation (SNP : gene mapping)
# $MAGMA --annotate window=35,10 --snp-loc ../MAGMA/GWAS_Results/PTSD_Nievergelt2019.snploc --gene-loc $ANNO --out SNP_Data/PTSD_Nievergelt2019_10xPilotGenes

## Step 2 - Gene analysis (from SNP-wise summary stats)
# $MAGMA --bfile $BFILE --gene-annot SNP_Data/PTSD_Nievergelt2019_10xPilotGenes.genes.annot --pval ../MAGMA/GWAS_Results/MVP.TE.REX.txt use=SNP,P ncol=N --gene-model ${model} --out SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_${model}

## Step 3 - Gene set analyses (using gene-level output)  -  for five brain regions
echo "Update MNT 05May2021 - running an iteration (into 'Results_v2') with the preprint stats, applying a filter for non-0-median expression, in each respective subcluster."
echo "Update MNT 14Jul2021 - running an iteration (into 'Results_rev') following the above approach, finally with final revision cell classes."


$MAGMA --gene-results SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_snp-wise.genes.raw --set-annot $gs_dlpfc gene-col=${genecol} set-col=${setcol} --out Results_rev/dlpfc_PTSD
# $MAGMA --gene-results SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_snp-wise.genes.raw --set-annot $gs_sacc gene-col=${genecol} set-col=${setcol} --out Results_rev/sacc_PTSD
$MAGMA --gene-results SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_snp-wise.genes.raw --set-annot $gs_hpc gene-col=${genecol} set-col=${setcol} --out Results_rev/hpc_PTSD
$MAGMA --gene-results SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_snp-wise.genes.raw --set-annot $gs_nac gene-col=${genecol} set-col=${setcol} --out Results_rev/nac_PTSD
# $MAGMA --gene-results SNP_Data/PTSD_Nievergelt2019_10xPilotGenes_snp-wise.genes.raw --set-annot $gs_amy gene-col=${genecol} set-col=${setcol} --out Results_rev/amy_PTSD

for trait in ["SCZ", "AD","MDD"]:
scdrs perform-downstream \
--h5ad-file sce.h5ad \
--score-file out/step3/AD_2019.full_score.gz \
--out-folder out/step4 \
--group-analysis fine.type \
--corr-analysis nmf1,nmf2,nmf3,nmf4,nmf5,nmf6,nmf7,nmf8,nmf9,nmf10,nmf11,nmf12,nmf13,nmf14,nmf15,nmf16,nmf17,nmf18,nmf19,nmf20,nmf21,nmf22,nmf23,nmf24,nmf25,nmf26,nmf27,nmf28,nmf29,nmf30,nmf31,nmf32,nmf33,nmf34,nmf35,nmf36,nmf37,nmf38,nmf39,nmf40,nmf41,nmf42,nmf43,nmf44,nmf45,nmf46,nmf47,nmf48,nmf49,nmf50,nmf51,nmf52,nmf53,nmf54,nmf55,nmf56,nmf57,nmf58,nmf59,nmf60,nmf61,nmf62,nmf63,nmf64,nmf65,nmf66,nmf67,nmf68,nmf69,nmf70,nmf71,nmf72,nmf73,nmf74,nmf75,nmf76,nmf77,nmf78,nmf79,nmf80,nmf81,nmf82,nmf83,nmf84,nmf85,nmf86,nmf87,nmf88,nmf89,nmf90,nmf91,nmf92,nmf93,nmf94,nmf95,nmf96,nmf97,nmf98,nmf99,nmf100 \
--gene-analysis \
--flag-filter-data False \
--flag-raw-count False


scdrs compute-score \
--h5ad-file sce.h5ad \
--h5ad-species human \
--gs-file out/step3/genesets.gs \
--gs-species human \
--out-folder out/step3 \
--flag-filter-data False \
--flag-raw-count False \
--n-ctrl 1000 \
--cov-file cov.tsv \
--flag-return-ctrl-raw-score False \
--flag-return-ctrl-norm-score True
